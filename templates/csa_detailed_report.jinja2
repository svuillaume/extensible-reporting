<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FortiCNAPP Rapid Cloud Assessment - {{customer}}</title>
    <link rel="stylesheet" href="https://fonts.xz.style/serve/inter.css">
    <style type="text/css">
        :root {
            --color-critical: #DC2626;
            --color-critical-bg: #FEE2E2;
            --color-high: #EA580C;
            --color-high-bg: #FFEDD5;
            --color-medium: #CA8A04;
            --color-medium-bg: #FEF3C7;
            --color-low: #2563EB;
            --color-low-bg: #DBEAFE;
            --color-success: #16A34A;
            --color-success-bg: #DCFCE7;
            --color-primary: #307FE2;
            --color-primary-dark: #1E5BB8;
            --color-text: #1F2937;
            --color-text-light: #6B7280;
            --color-border: #E5E7EB;
            --color-bg-light: #F9FAFB;
        }

        @media print {
            {% if pagesize %}
            @page {
                size: {{pagesize}} landscape;
                margin: 1cm 1.5cm;
            }
            {% endif %}

            /* Minimal print rules - keep exact HTML layout */
            .pagebreak {
                page-break-after: always;
                clear: both;
            }

            .no-print {
                display: none !important;
            }

            /* Remove hover effects for print */
            tbody tr:hover {
                background: transparent !important;
            }

            /* Prevent awkward page breaks */
            .action-card,
            .finding-card,
            .info-box,
            .summary-card,
            header,
            .report-title,
            table {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 1.5rem;
            color: var(--color-text);
            background: #FFFFFF;
            line-height: 1.6;
            font-size: 14px;
        }

        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 3px solid var(--color-primary);
            margin-bottom: 2rem;
        }

        header img {
            height: 45px;
        }

        /* Title Section */
        .report-title {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .report-title h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            border: none;
        }

        .report-title .subtitle {
            font-size: 1.25rem;
            opacity: 0.9;
        }

        .report-title .meta {
            margin-top: 1.5rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            opacity: 0.85;
        }

        .report-title .meta span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Section Headers */
        h2 {
            font-size: 1.75rem;
            color: var(--color-text);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.75rem;
            margin: 2.5rem 0 1.5rem 0;
            clear: both;
        }

        h3 {
            font-size: 1.35rem;
            color: var(--color-text);
            margin: 2rem 0 1rem 0;
            clear: both;
        }

        h4 {
            font-size: 1.1rem;
            color: var(--color-text);
            margin: 1.5rem 0 1rem 0;
            clear: both;
        }

        p {
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        /* Executive Summary Cards */
        .summary-grid {
            width: 100%;
            margin: 2rem 0;
            overflow: hidden;
        }

        .summary-grid::after {
            content: "";
            display: table;
            clear: both;
        }

        .summary-card {
            float: left;
            width: 23%;
            margin-right: 2.666%;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--color-border);
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }

        .summary-card:nth-child(4n) {
            margin-right: 0;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .summary-card.critical {
            border-top: 4px solid var(--color-critical);
        }

        .summary-card.high {
            border-top: 4px solid var(--color-high);
        }

        .summary-card.warning {
            border-top: 4px solid var(--color-medium);
        }

        .summary-card.info {
            border-top: 4px solid var(--color-primary);
        }

        .summary-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .summary-card.critical .number { color: var(--color-critical); }
        .summary-card.high .number { color: var(--color-high); }
        .summary-card.warning .number { color: var(--color-medium); }
        .summary-card.info .number { color: var(--color-primary); }

        .summary-card .label {
            font-size: 0.85rem;
            color: var(--color-text-light);
            line-height: 1.3;
        }

        /* Action Cards */
        .action-section {
            background: var(--color-bg-light);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
        }

        .action-section h3 {
            color: var(--color-primary-dark);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-section h3::before {
            content: "!";
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .action-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0 0;
        }

        .action-list li {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--color-primary);
        }

        .action-list li.priority-critical {
            border-left-color: var(--color-critical);
            background: var(--color-critical-bg);
        }

        .action-list li.priority-high {
            border-left-color: var(--color-high);
            background: var(--color-high-bg);
        }

        .action-list li.priority-medium {
            border-left-color: var(--color-medium);
            background: var(--color-medium-bg);
        }

        .action-list .action-number {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .action-list li.priority-critical .action-number { background: var(--color-critical); }
        .action-list li.priority-high .action-number { background: var(--color-high); }
        .action-list li.priority-medium .action-number { background: var(--color-medium); }

        .action-content {
            flex: 1;
        }

        .action-content strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        .action-content p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--color-text-light);
        }

        /* Severity Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-critical {
            background: var(--color-critical-bg);
            color: var(--color-critical);
        }

        .badge-high {
            background: var(--color-high-bg);
            color: var(--color-high);
        }

        .badge-medium {
            background: var(--color-medium-bg);
            color: var(--color-medium);
        }

        .badge-low {
            background: var(--color-low-bg);
            color: var(--color-low);
        }

        /* NIST CSF Function Badges */
        .nist-badge {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            margin-left: 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nist-identify {
            background: #E0E7FF;
            color: #3730A3;
            border: 1px solid #A5B4FC;
        }

        .nist-protect {
            background: #DBEAFE;
            color: #1E40AF;
            border: 1px solid #93C5FD;
        }

        .nist-detect {
            background: #FEF3C7;
            color: #92400E;
            border: 1px solid #FCD34D;
        }

        .nist-respond {
            background: #FED7AA;
            color: #9A3412;
            border: 1px solid #FDBA74;
        }

        .nist-recover {
            background: #D1FAE5;
            color: #065F46;
            border: 1px solid #6EE7B7;
        }

        /* Risk Score Meter */
        .risk-meter {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            border: 1px solid var(--color-border);
        }

        .risk-meter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .risk-meter-bar {
            height: 12px;
            background: #E5E7EB;
            border-radius: 6px;
            overflow: hidden;
        }

        .risk-meter-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .risk-meter-fill.critical { background: linear-gradient(90deg, var(--color-high) 0%, var(--color-critical) 100%); }
        .risk-meter-fill.high { background: linear-gradient(90deg, var(--color-medium) 0%, var(--color-high) 100%); }
        .risk-meter-fill.medium { background: linear-gradient(90deg, var(--color-low) 0%, var(--color-medium) 100%); }
        .risk-meter-fill.low { background: var(--color-success); }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        thead th {
            background: var(--color-primary);
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1rem;
            text-align: left;
        }

        tbody tr {
            border-bottom: 1px solid var(--color-border);
        }

        tbody tr:nth-child(even) {
            background: var(--color-bg-light);
        }

        tbody tr:hover {
            background: #EBF5FF;
        }

        td, th {
            padding: 0.875rem 1rem;
            font-size: 0.875rem;
            max-width: 200px;
            word-wrap: break-word;
        }

        td {
            color: var(--color-text);
        }

        /* Info Boxes */
        .info-box {
            padding: 1.25rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            display: flex;
            gap: 1rem;
        }

        .info-box.tip {
            background: #EBF5FF;
            border: 1px solid #93C5FD;
        }

        .info-box.warning {
            background: var(--color-medium-bg);
            border: 1px solid #FCD34D;
        }

        .info-box.alert {
            background: var(--color-critical-bg);
            border: 1px solid #FCA5A5;
        }

        .info-box-icon {
            font-size: 1.25rem;
        }

        .info-box-content {
            flex: 1;
        }

        .info-box-content strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        /* Finding Cards */
        .finding-card {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .finding-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .finding-card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .finding-card-body {
            color: var(--color-text-light);
            font-size: 0.9rem;
        }

        /* TOC / Navigation */
        .toc {
            background: var(--color-bg-light);
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin: 2rem auto;
            max-width: 900px;
        }

        .toc h3 {
            margin-top: 0;
            font-size: 1.1rem;
            text-align: center;
        }

        .toc-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0 0 0;
            columns: 2;
            column-gap: 2rem;
        }

        .toc-list li {
            padding: 0.5rem 0;
            border-bottom: 1px dotted var(--color-border);
        }

        .toc-list a {
            color: var(--color-primary);
            text-decoration: none;
        }

        .toc-list a:hover {
            text-decoration: underline;
        }

        /* Promo Section */
        .promo-section {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
            width: 100%;
            max-width: 100%;
        }

        .promo-section img {
            max-width: 85%;
            width: 85%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* Cover page image - smaller to fit on first page */
        .cover-image img {
            max-width: 70%;
            width: 70%;
        }

        /* Value Props */
        .value-props {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .value-prop {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--color-bg-light);
            border-radius: 8px;
        }

        .value-prop-icon {
            width: 40px;
            height: 40px;
            background: var(--color-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .value-prop-text {
            font-size: 0.9rem;
        }

        /* Recommendations Section */
        .recommendations {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            border: 1px solid #7dd3fc;
        }

        .recommendations h2 {
            border-bottom: none;
            margin-top: 0;
        }

        .recommendations ol {
            margin: 1rem 0 0 1.5rem;
        }

        .recommendations li {
            margin-bottom: 0.75rem;
        }

        /* Specific table styles */
        table.host_vulns_summary_by_host td.col1 {
            white-space: pre;
            text-align: left;
        }

        table.container_vulns_summary_by_image td.col2 {
            white-space: pre;
            text-align: left;
        }

        table.compliance_detail td.col0 {
            white-space: nowrap;
        }

        /* Footer */
        footer {
            margin-top: 3rem;
            padding: 2rem;
            background: var(--color-bg-light);
            border-top: 1px solid var(--color-border);
            text-align: center;
            color: var(--color-text-light);
            font-size: 0.85rem;
        }

        /* Utilities */
        .text-center { text-align: center; }
        .text-muted { color: var(--color-text-light); }
        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        .pagebreak { page-break-after: always; clear: both; }
    </style>
</head>
<body>

<header>
    {% if company_logo_html %}
    {{ company_logo_html | safe }}
    {% endif %}
    {% if custom_logo_html %}
    {{ custom_logo_html | safe}}
    {% endif %}
</header>

<!-- Title Section -->
<div class="report-title">
    <h1>FortiCNAPP Rapid Cloud Assessment</h1>
    <div class="subtitle">Comprehensive Security Posture Analysis for {{customer}}</div>
    <div class="meta">
        <span>Report Date: {{date}}</span>
        <span>Prepared by: {{author}}</span>
    </div>
</div>

<!-- Cloud Status Quo -->
<section class="pagebreak">
    <div class="promo-section cover-image">
        {% if cloud_status_quo_html %}{{ cloud_status_quo_html | safe }}{% endif %}
    </div>
</section>

<!-- Table of Contents -->
<div class="toc">
    <h3>Quick Navigation</h3>
    <ul class="toc-list">
        <li><a href="#executive-summary">Executive Summary</a></li>
        <li><a href="#immediate-actions">Immediate Actions Required</a></li>
        {% if secrets_data and secrets_data.secrets_count > 0 %}<li><a href="#secrets">Exposed Secrets</a></li>{% endif %}
        {% if aws_compliance_data or azure_compliance_data or gcp_compliance_data %}<li><a href="#compliance">Compliance Findings</a></li>{% endif %}
        {% if alerts_data %}<li><a href="#alerts">Security Alerts</a></li>{% endif %}
        {% if ciem_data %}<li><a href="#ciem">Identity & Entitlement Management (CIEM)</a></li>{% endif %}
        {% if host_vulns_data or container_vulns_data %}<li><a href="#vulnerabilities">Vulnerability Assessment</a></li>{% endif %}
        <li><a href="#detailed-findings">Detailed Findings</a></li>
        <li><a href="#recommendations">Recommendations</a></li>
    </ul>
</div>

<!-- Executive Summary Section -->
<section id="executive-summary">
    <h2>Executive Summary</h2>

    <p>
        This Cloud Security Assessment provides a comprehensive analysis of {{customer}}'s security posture across cloud infrastructure, workloads, and compliance frameworks. The findings below represent actionable intelligence to strengthen your security position.
    </p>

    <!-- Key Metrics -->
    <div class="summary-grid">
        {% if host_vulns_data %}
        <div class="summary-card critical">
            <div class="number">{{host_vulns_data.critical_vuln_count}}</div>
            <div class="label">Hosts with Critical Vulnerabilities</div>
        </div>
        {% endif %}

        {% if container_vulns_data %}
        <div class="summary-card critical">
            <div class="number">{{container_vulns_data.critical_vuln_count}}</div>
            <div class="label">Containers with Critical Vulnerabilities</div>
        </div>
        {% endif %}

        {% if aws_compliance_data %}
        <div class="summary-card high">
            <div class="number">{{aws_compliance_data.critical_finding_count}}</div>
            <div class="label">Critical AWS Compliance Findings</div>
        </div>
        {% endif %}

        {% if azure_compliance_data %}
        <div class="summary-card high">
            <div class="number">{{azure_compliance_data.critical_finding_count}}</div>
            <div class="label">Critical Azure Compliance Findings</div>
        </div>
        {% endif %}

        {% if gcp_compliance_data %}
        <div class="summary-card high">
            <div class="number">{{gcp_compliance_data.critical_finding_count}}</div>
            <div class="label">Critical GCP Compliance Findings</div>
        </div>
        {% endif %}

        {% if alerts_data %}
        <div class="summary-card warning">
            <div class="number">{{ alerts_data.high_critical_finding_count }}</div>
            <div class="label">High/Critical Behavioral Alerts</div>
        </div>
        {% endif %}

        {% if secrets_data %}
        <div class="summary-card {% if secrets_data.secrets_count > 0 %}critical{% else %}info{% endif %}">
            <div class="number">{{ secrets_data.secrets_count }}</div>
            <div class="label">Exposed Secrets Detected</div>
        </div>
        {% endif %}

        {% if ciem_data and ciem_data.AZURE and ciem_data.AZURE.high_risk_count_80 is defined and ciem_data.AZURE.high_risk_count_80 > 0 %}
        <div class="summary-card high">
            <div class="number">{{ ciem_data.AZURE.high_risk_count_80 }}</div>
            <div class="label">Azure High Privilege Identities<br><span style="font-size: 0.85em;">(≥80 unused entitlements)</span></div>
        </div>
        {% endif %}
    </div>

    <!-- Promo Graphic -->
    {% if pdf %}
    <div class="promo-section">
        {% if polygraph_graphic_html %}{{ polygraph_graphic_html | safe }}{% endif %}
    </div>
    {% else %}
    <div class="promo-section">
        {% if polygraph_graphic_html %}{{ polygraph_graphic_html | safe }}{% endif %}
    </div>
    {% endif %}
</section>

<!-- Immediate Actions Section -->
<section id="immediate-actions">
    <div class="action-section">
        <h3>Immediate Actions Required</h3>
        <p>Based on the assessment findings, the following actions are prioritized by severity and impact:</p>

        <ol class="action-list">
            {% if secrets_data and secrets_data.secrets_count > 0 %}
            <li class="priority-critical">
                <span class="action-number">1</span>
                <div class="action-content">
                    <strong>Rotate Exposed Secrets Immediately</strong>
                    <p>{{secrets_data.secrets_count}} secret(s) have been detected in your workloads. Rotate these credentials and investigate potential unauthorized access.</p>
                </div>
            </li>
            {% endif %}

            {% if host_vulns_data and host_vulns_data.critical_vuln_count > 0 %}
            <li class="priority-critical">
                <span class="action-number">{% if secrets_data and secrets_data.secrets_count > 0 %}2{% else %}1{% endif %}</span>
                <div class="action-content">
                    <strong>Patch Critical Host Vulnerabilities</strong>
                    <p>{{host_vulns_data.critical_vuln_count}} host(s) have critical vulnerabilities with available patches. Prioritize patching systems with network exposure.</p>
                </div>
            </li>
            {% endif %}

            {% if container_vulns_data and container_vulns_data.critical_vuln_count > 0 %}
            <li class="priority-critical">
                <span class="action-number">{% set n = 1 %}{% if secrets_data and secrets_data.secrets_count > 0 %}{% set n = n + 1 %}{% endif %}{% if host_vulns_data and host_vulns_data.critical_vuln_count > 0 %}{% set n = n + 1 %}{% endif %}{{n}}</span>
                <div class="action-content">
                    <strong>Rebuild Vulnerable Container Images</strong>
                    <p>{{container_vulns_data.critical_vuln_count}} container image(s) contain critical vulnerabilities. Update base images and redeploy affected workloads.</p>
                </div>
            </li>
            {% endif %}

            {% if aws_compliance_data and aws_compliance_data.critical_finding_count > 0 %}
            <li class="priority-high">
                <span class="action-number">{% set n = 1 %}{% if secrets_data and secrets_data.secrets_count > 0 %}{% set n = n + 1 %}{% endif %}{% if host_vulns_data and host_vulns_data.critical_vuln_count > 0 %}{% set n = n + 1 %}{% endif %}{% if container_vulns_data and container_vulns_data.critical_vuln_count > 0 %}{% set n = n + 1 %}{% endif %}{{n}}</span>
                <div class="action-content">
                    <strong>Address AWS Compliance Gaps</strong>
                    <p>{{aws_compliance_data.critical_finding_count}} critical compliance finding(s) detected. Review IAM policies, encryption settings, and network configurations.</p>
                </div>
            </li>
            {% endif %}

            {% if azure_compliance_data and azure_compliance_data.critical_finding_count > 0 %}
            <li class="priority-high">
                <span class="action-number">{% set n = 1 %}{% if secrets_data and secrets_data.secrets_count > 0 %}{% set n = n + 1 %}{% endif %}{% if host_vulns_data and host_vulns_data.critical_vuln_count > 0 %}{% set n = n + 1 %}{% endif %}{% if container_vulns_data and container_vulns_data.critical_vuln_count > 0 %}{% set n = n + 1 %}{% endif %}{% if aws_compliance_data and aws_compliance_data.critical_finding_count > 0 %}{% set n = n + 1 %}{% endif %}{{n}}</span>
                <div class="action-content">
                    <strong>Address Azure Compliance Gaps</strong>
                    <p>{{azure_compliance_data.critical_finding_count}} critical compliance finding(s) detected. Review Azure AD, storage security, and network security groups.</p>
                </div>
            </li>
            {% endif %}

            {% if alerts_data and alerts_data.high_critical_finding_count > 0 %}
            <li class="priority-high">
                <span class="action-number">{% set n = 1 %}{% if secrets_data and secrets_data.secrets_count > 0 %}{% set n = n + 1 %}{% endif %}{% if host_vulns_data and host_vulns_data.critical_vuln_count > 0 %}{% set n = n + 1 %}{% endif %}{% if container_vulns_data and container_vulns_data.critical_vuln_count > 0 %}{% set n = n + 1 %}{% endif %}{% if aws_compliance_data and aws_compliance_data.critical_finding_count > 0 %}{% set n = n + 1 %}{% endif %}{% if azure_compliance_data and azure_compliance_data.critical_finding_count > 0 %}{% set n = n + 1 %}{% endif %}{{n}}</span>
                <div class="action-content">
                    <strong>Investigate Behavioral Alerts</strong>
                    <p>{{alerts_data.high_critical_finding_count}} high/critical behavioral alert(s) require investigation for potential security incidents or policy violations.</p>
                </div>
            </li>
            {% endif %}

            <li class="priority-medium">
                <span class="action-number">+</span>
                <div class="action-content">
                    <strong>Schedule Regular Assessments</strong>
                    <p>Implement continuous security monitoring and schedule recurring assessments to track remediation progress and detect new risks.</p>
                </div>
            </li>
        </ol>
    </div>
</section>

<!-- Secrets Section -->
{% if secrets_data and secrets_data.secrets_count > 0 %}
<section id="secrets" class="pagebreak">
    <h2>Exposed Secrets <span class="badge badge-critical">CRITICAL</span></h2>

    <div class="info-box alert">
        <div class="info-box-icon">!</div>
        <div class="info-box-content">
            <strong>Immediate Action Required</strong>
            The following SSH keys and secrets have been detected in your workloads. These should be rotated immediately and the source of exposure investigated.
        </div>
    </div>

    {{ secrets_data.secrets_raw.to_html(index=False) | safe }}

    <div class="action-section">
        <h3>Remediation Steps</h3>
        <ol class="action-list">
            <li class="priority-critical">
                <span class="action-number">1</span>
                <div class="action-content">
                    <strong>Rotate all exposed credentials</strong>
                    <p>Generate new SSH keys and update all systems using the compromised keys.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">2</span>
                <div class="action-content">
                    <strong>Audit access logs</strong>
                    <p>Review authentication logs for any unauthorized access using the exposed credentials.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">3</span>
                <div class="action-content">
                    <strong>Implement secrets management</strong>
                    <p>Use a secrets manager (HashiCorp Vault, AWS Secrets Manager) to prevent future exposure.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">4</span>
                <div class="action-content">
                    <strong>Review File Permissions (DAC – Discretionary Access Control)</strong>
                    <p>Verify and restrict file permissions on all secret files to ensure only authorized users and processes can access them. Implement least-privilege access controls using appropriate file permissions (e.g., 600 for private keys).</p>
                </div>
            </li>
        </ol>
    </div>
</section>
{% endif %}

<!-- Compliance Findings Section -->
{% if aws_compliance_data or azure_compliance_data or gcp_compliance_data %}
<section id="compliance" class="pagebreak">
    <h2>Compliance Findings</h2>

    <p>
        FortiCNAPP has assessed your cloud security posture against CIS benchmarks and industry best practices. The following findings highlight areas requiring attention to maintain compliance and reduce risk.
    </p>

    {% if aws_compliance_data and aws_compliance_data.summary_count > 0 %}
    <div class="finding-card">
        <div class="finding-card-header">
            <div class="finding-card-title">AWS Compliance Assessment</div>
            <span class="badge {% if aws_compliance_data.critical_finding_count > 0 %}badge-critical{% else %}badge-medium{% endif %}">
                {{aws_compliance_data.critical_finding_count}} Critical
            </span>
        </div>
        <div class="finding-card-body">
            <p><strong>Total AWS Accounts Analyzed:</strong> {{aws_compliance_data.cloud_accounts_count}}</p>
            {{ aws_compliance_data.compliance_summary.to_html(index=False) | safe }}
            {{ aws_compliance_data.compliance_findings_by_service_bar_graphic | safe }}
            {{ aws_compliance_data.compliance_findings_by_account_bar_graphic | safe }}
        </div>
    </div>
    {% endif %}

    {% if azure_compliance_data and azure_compliance_data.summary_count > 0 %}
    <div class="finding-card pagebreak">
        <div class="finding-card-header">
            <div class="finding-card-title">Azure Compliance Assessment</div>
            <span class="badge {% if azure_compliance_data.critical_finding_count > 0 %}badge-critical{% else %}badge-medium{% endif %}">
                {{azure_compliance_data.critical_finding_count}} Critical
            </span>
        </div>
        <div class="finding-card-body">
            <p><strong>Total Azure Subscriptions Analyzed:</strong> {{azure_compliance_data.cloud_accounts_count}}</p>
            {{ azure_compliance_data.compliance_summary.to_html(index=False) | safe }}
            {{ azure_compliance_data.compliance_findings_by_service_bar_graphic | safe }}
            {{ azure_compliance_data.compliance_findings_by_account_bar_graphic | safe }}
        </div>
    </div>
    {% endif %}

    {% if gcp_compliance_data and gcp_compliance_data.summary_count > 0 %}
    <div class="finding-card pagebreak">
        <div class="finding-card-header">
            <div class="finding-card-title">GCP Compliance Assessment</div>
            <span class="badge {% if gcp_compliance_data.critical_finding_count > 0 %}badge-critical{% else %}badge-medium{% endif %}">
                {{gcp_compliance_data.critical_finding_count}} Critical
            </span>
        </div>
        <div class="finding-card-body">
            <p><strong>Total GCP Projects Analyzed:</strong> {{gcp_compliance_data.cloud_accounts_count}}</p>
            {{ gcp_compliance_data.compliance_summary.to_html(index=False) | safe }}
            {{ gcp_compliance_data.compliance_findings_by_service_bar_graphic | safe }}
            {{ gcp_compliance_data.compliance_findings_by_account_bar_graphic | safe }}
        </div>
    </div>
    {% endif %}
</section>
{% endif %}

<!-- Alerts Section -->
{% if alerts_data %}
<section id="alerts" class="pagebreak">
    <h2>Security Alerts & Anomalies</h2>

    <div class="info-box {% if alerts_data.high_critical_finding_count > 0 %}warning{% else %}tip{% endif %}">
        <div class="info-box-icon">i</div>
        <div class="info-box-content">
            <strong>Behavioral Analysis (Last 7 Days)</strong>
            FortiCNAPP has identified {{alerts_data.high_critical_finding_count}} high/critical behavioral anomalies that may indicate security incidents, policy violations, or misconfigurations requiring investigation.
        </div>
    </div>

    <h4>Top 25 Alerts by Severity</h4>
    {{ alerts_data.alerts_raw.to_html(index=False) | safe }}

    {% if alerts_data.high_critical_finding_count > 0 %}
    <div class="action-section">
        <h3>Investigation Guidance</h3>
        <ol class="action-list">
            <li class="priority-high">
                <span class="action-number">1</span>
                <div class="action-content">
                    <strong>Review Critical/High Alerts First</strong>
                    <p>Focus on alerts indicating potential compromise, data exfiltration, or privilege escalation.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">2</span>
                <div class="action-content">
                    <strong>Correlate with Access Logs</strong>
                    <p>Cross-reference alert timestamps with CloudTrail, Azure Activity Logs, or GCP Audit Logs.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">3</span>
                <div class="action-content">
                    <strong>Update Detection Rules</strong>
                    <p>Tune FortiCNAPP policies to reduce false positives and enhance detection accuracy.</p>
                </div>
            </li>
        </ol>
    </div>
    {% endif %}
</section>
{% endif %}

<!-- CIEM Section -->
{% if ciem_data %}
<section id="ciem" class="pagebreak">
    <h2>Cloud Identity & Entitlement Management (CIEM)</h2>

    <p>
        Analysis of cloud identities with excessive privileges and unused entitlements across AWS, Azure, and GCP environments. Identities with high unused permissions represent a significant security risk and should be reviewed for least privilege adherence.
    </p>

    <!-- Summary Cards -->
    <div class="summary-grid">
        {% if ciem_data.AWS and ciem_data.AWS.high_privilege_count is defined %}
        <div class="summary-card {% if ciem_data.AWS.high_privilege_count > 0 %}critical{% else %}success{% endif %}">
            <div class="number">{{ ciem_data.AWS.high_privilege_count }}</div>
            <div class="label">AWS High Privilege Identities</div>
            <div class="sublabel">≥{{ ciem_data.AWS.threshold }} unused entitlements</div>
        </div>
        <div class="summary-card info">
            <div class="number">{{ ciem_data.AWS.total_identities }}</div>
            <div class="label">Total AWS Identities Analyzed</div>
            <div class="sublabel">{{ ciem_data.AWS.root_count }} with root access</div>
        </div>
        {% endif %}

        {% if ciem_data.AZURE and ciem_data.AZURE.high_privilege_count is defined %}
        <div class="summary-card {% if ciem_data.AZURE.high_privilege_count > 0 %}critical{% else %}success{% endif %}">
            <div class="number">{{ ciem_data.AZURE.high_privilege_count }}</div>
            <div class="label">Azure High Privilege Identities</div>
            <div class="sublabel">≥{{ ciem_data.AZURE.threshold }} unused entitlements</div>
        </div>
        <div class="summary-card info">
            <div class="number">{{ ciem_data.AZURE.total_identities }}</div>
            <div class="label">Total Azure Identities Analyzed</div>
            <div class="sublabel">{{ ciem_data.AZURE.root_count }} with root access</div>
        </div>
        {% endif %}

        {% if ciem_data.GCP and ciem_data.GCP.high_privilege_count is defined %}
        <div class="summary-card {% if ciem_data.GCP.high_privilege_count > 0 %}critical{% else %}success{% endif %}">
            <div class="number">{{ ciem_data.GCP.high_privilege_count }}</div>
            <div class="label">GCP High Privilege Identities</div>
            <div class="sublabel">≥{{ ciem_data.GCP.threshold }} unused entitlements</div>
        </div>
        <div class="summary-card info">
            <div class="number">{{ ciem_data.GCP.total_identities }}</div>
            <div class="label">Total GCP Identities Analyzed</div>
            <div class="sublabel">{{ ciem_data.GCP.root_count }} with root access</div>
        </div>
        {% endif %}
    </div>

    <!-- High Privilege Identities Tables by Provider -->
    {% for provider in ['AWS', 'AZURE', 'GCP'] %}
        {% if ciem_data[provider] and ciem_data[provider].high_privilege_count is defined %}

        {% if ciem_data[provider].high_privilege_count > 0 %}
        <h3>{{ provider }} High Privilege Identities (≥{{ ciem_data[provider].threshold }} Unused Entitlements)</h3>

        <div class="info-box alert">
            <div class="info-box-icon">!</div>
            <div class="info-box-content">
                <strong>High Privilege Identities Detected</strong>
                {{ ciem_data[provider].high_privilege_count }} {{ provider }} identities have ≥{{ ciem_data[provider].threshold }} unused entitlements. These over-provisioned identities should be reviewed for least privilege compliance.
            </div>
        </div>

        <table class="ciem-high-privilege-identities" style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
            <thead>
                <tr style="background-color: #f5f5f5;">
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left;">Principal ID</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left;">Name</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">Admin</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">MFA</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">Unused Entitlements</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">Risk</th>
                </tr>
            </thead>
            <tbody>
                {% for row in ciem_data[provider].high_privilege_identities.itertuples() %}
                <tr style="{% if row.has_full_admin %}background-color: #ffebee;{% endif %}">
                    <td style="padding: 0.4rem; border: 1px solid #ddd;"><code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px; font-size: 0.85em;">{{ row.PRINCIPAL_ID[:40] }}...</code></td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd;">{{ row.NAME }}</td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        {% if row.has_full_admin %}
                        <span style="color: #d32f2f; font-weight: bold;">✓</span>
                        {% else %}
                        <span style="color: #999;">-</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        <span class="badge {% if row.mfa_status == 'Enabled' %}success{% elif row.mfa_status == 'Disabled' %}critical{% else %}medium{% endif %}" style="padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8em;">
                            {{ row.mfa_status }}
                        </span>
                    </td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        <strong style="color: #d32f2f;">{{ row.unused_count }}</strong> / {{ row.total_count }}
                        <br><span style="color: #666; font-size: 0.85em;">({{ row.unused_percentage }}%)</span>
                    </td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        <span class="badge {% if row.risk_severity == 'CRITICAL' %}critical{% elif row.risk_severity == 'HIGH' %}high{% else %}medium{% endif %}" style="padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8em;">
                            {{ row.risk_severity }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p style="font-size: 0.85em; color: #666; margin-top: 0.5rem;">
            <strong style="background: #ffebee; padding: 2px 4px;">Highlighted rows</strong> indicate identities with full administrative access.
            MFA status: <span class="badge success" style="padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8em;">Enabled</span> = MFA configured,
            <span class="badge critical" style="padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8em;">Disabled</span> = No MFA,
            <span class="badge medium" style="padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8em;">Unknown</span> = Status not determined.
        </p>
        {% endif %}

        <!-- Show Root Identities (even if not critical) -->
        {% if ciem_data[provider].root_count > 0 and ciem_data[provider].root_count > ciem_data[provider].critical_count %}
        <h3>{{ provider }} Identities with Root/Admin Access</h3>
        <p style="margin: 0.5rem 0;">
            Found {{ ciem_data[provider].root_count }} identities with full administrative privileges.
            {% if ciem_data[provider].critical_count == 0 %}
            None have ≥{{ ciem_data[provider].threshold }} unused entitlements.
            {% endif %}
        </p>
        {% endif %}

        <!-- Show High Privilege Identities (even if not root) -->
        {% if ciem_data[provider].high_privilege_count > 0 and ciem_data[provider].high_privilege_count > ciem_data[provider].critical_count %}
        <h3>{{ provider }} Identities with Excessive Unused Entitlements</h3>
        <p style="margin: 0.5rem 0;">
            Found {{ ciem_data[provider].high_privilege_count }} identities with ≥{{ ciem_data[provider].threshold }} unused entitlements.
            {% if ciem_data[provider].critical_count == 0 %}
            None have full administrative access.
            {% endif %}
        </p>
        {% endif %}

        <!-- Show Top Identities Table (ALL identities, sorted by risk) -->
        {% if ciem_data[provider].all_identities is defined and not ciem_data[provider].all_identities.empty %}
        <h3>{{ provider }} Top Identity Risks (by Unused Entitlements)</h3>

        <table class="ciem-all-identities" style="width: 100%; border-collapse: collapse; margin: 1rem 0; font-size: 0.9em;">
            <thead>
                <tr style="background-color: #f5f5f5;">
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left;">Principal ID</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: left;">Name</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">Admin</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">MFA</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">Unused %</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">Unused/Total</th>
                    <th style="padding: 0.5rem; border: 1px solid #ddd; text-align: center;">Risk</th>
                </tr>
            </thead>
            <tbody>
                {% for row in ciem_data[provider].all_identities.itertuples() %}
                <tr style="{% if row.has_full_admin and row.unused_count >= ciem_data[provider].threshold %}background-color: #ffebee;{% endif %}">
                    <td style="padding: 0.4rem; border: 1px solid #ddd;"><code style="background: #f5f5f5; padding: 2px 4px; border-radius: 3px; font-size: 0.85em;">{{ row.PRINCIPAL_ID[:30] }}...</code></td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd;">{{ row.NAME }}</td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        {% if row.has_full_admin %}
                        <span style="color: #d32f2f; font-weight: bold;">✓</span>
                        {% else %}
                        <span style="color: #999;">-</span>
                        {% endif %}
                    </td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        <span class="badge {% if row.mfa_status == 'Enabled' %}success{% elif row.mfa_status == 'Disabled' %}critical{% else %}medium{% endif %}" style="padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.75em;">
                            {{ row.mfa_status }}
                        </span>
                    </td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        <strong style="{% if row.unused_count >= ciem_data[provider].threshold %}color: #d32f2f;{% endif %}">{{ row.unused_percentage }}%</strong>
                    </td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        <strong style="{% if row.unused_count >= ciem_data[provider].threshold %}color: #d32f2f;{% endif %}">{{ row.unused_count }}</strong> / {{ row.total_count }}
                    </td>
                    <td style="padding: 0.4rem; border: 1px solid #ddd; text-align: center;">
                        <span class="badge {% if row.risk_severity == 'CRITICAL' %}critical{% elif row.risk_severity == 'HIGH' %}high{% elif row.risk_severity == 'MEDIUM' %}medium{% else %}low{% endif %}" style="padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.8em;">
                            {{ row.risk_severity }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p style="font-size: 0.85em; color: #666; margin-top: 0.5rem;">
            Showing top 25 identities sorted by risk. Identities with <strong style="background: #ffebee; padding: 2px 4px;">highlighted rows</strong> have both admin access and ≥{{ ciem_data[provider].threshold }} unused entitlements.
        </p>
        {% endif %}

        {% endif %}
    {% endfor %}

    <!-- Recommendations -->
    {% set total_high_privilege = (ciem_data.AWS.high_privilege_count if ciem_data.AWS and ciem_data.AWS.high_privilege_count is defined else 0) + (ciem_data.AZURE.high_privilege_count if ciem_data.AZURE and ciem_data.AZURE.high_privilege_count is defined else 0) + (ciem_data.GCP.high_privilege_count if ciem_data.GCP and ciem_data.GCP.high_privilege_count is defined else 0) %}
    {% if total_high_privilege > 0 %}
    <div class="action-section">
        <h3>Recommended Actions</h3>
        <ol class="action-list">
            <li class="priority-high">
                <span class="action-number">1</span>
                <div class="action-content">
                    <strong>Enable MFA on All Identities</strong>
                    <p>Immediately enable Multi-Factor Authentication (MFA) for all identities, especially those with administrative access or high unused entitlements. MFA significantly reduces the risk of credential compromise.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">2</span>
                <div class="action-content">
                    <strong>Reduce Unused Entitlements (≥70)</strong>
                    <p>Review and remove unused permissions from identities with ≥70 unused entitlements. These over-provisioned identities violate least privilege principles and increase attack surface.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">3</span>
                <div class="action-content">
                    <strong>Review Administrative Access</strong>
                    <p>Audit all identities with full administrative access. Remove admin privileges where not absolutely necessary and implement role-based access control (RBAC).</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">4</span>
                <div class="action-content">
                    <strong>Implement Least Privilege Policies</strong>
                    <p>Apply the principle of least privilege across all identities. Grant only the minimum permissions required for each role and regularly review access rights.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">5</span>
                <div class="action-content">
                    <strong>Enable Just-In-Time (JIT) Access</strong>
                    <p>Implement temporary privilege escalation for administrative tasks instead of permanent admin access. Use JIT access mechanisms to reduce standing privileges.</p>
                </div>
            </li>
        </ol>
    </div>
    {% endif %}
</section>
{% endif %}

<!-- Vulnerabilities Section -->
{% if host_vulns_data or container_vulns_data %}
<section id="vulnerabilities" class="pagebreak">
    <h2>Workload Vulnerability Assessment</h2>

    <p>
        FortiCNAPP has performed agentless vulnerability scanning across your workloads. The following findings identify vulnerable hosts and container images with associated remediation guidance.
    </p>

    <div class="summary-grid">
        {% if host_vulns_data %}
        <div class="summary-card info">
            <div class="number">{{host_vulns_data.hosts_scanned_count}}</div>
            <div class="label">Total Hosts Scanned</div>
        </div>
        {% endif %}
        {% if container_vulns_data %}
        <div class="summary-card info">
            <div class="number">{{container_vulns_data.containers_scanned_count}}</div>
            <div class="label">Container Images Scanned</div>
        </div>
        {% endif %}
    </div>

    {% if host_vulns_data %}
    <h3>Host Vulnerability Summary</h3>
    {{ host_vulns_data.host_vulns_summary.to_html(index=False) | safe }}
    {{ host_vulns_data.host_vulns_summary_bar_graphic | safe }}

    {% if host_vulns_data.critical_vuln_count > 0 %}
    <div class="info-box alert">
        <div class="info-box-icon">!</div>
        <div class="info-box-content">
            <strong>Critical Vulnerabilities Detected</strong>
            {{host_vulns_data.critical_vuln_count}} host(s) have critical vulnerabilities. Prioritize patching based on network exposure and data sensitivity.
        </div>
    </div>
    {% endif %}

    {% if host_vulns_data.all_cves_detail is defined and not host_vulns_data.all_cves_detail.empty %}
    <h4>Detailed CVE List (High, Medium, Low Severity)</h4>
    <div class="info-box tip">
        <div class="info-box-icon">i</div>
        <div class="info-box-content">
            <strong>Additional Vulnerabilities</strong>
            The table below shows all High, Medium, and Low severity CVEs found across your hosts. Review and prioritize based on your environment and risk tolerance.
        </div>
    </div>
    {{ host_vulns_data.all_cves_detail.to_html(index=False) | safe }}
    {% endif %}
    {% endif %}

    {% if container_vulns_data %}
    <h3>Container Vulnerability Summary</h3>
    {{ container_vulns_data.container_vulns_summary.to_html(index=False) | safe }}
    {{ container_vulns_data.container_vulns_summary_by_package_bar_graphic | safe }}

    {% if container_vulns_data.critical_vuln_count > 0 %}
    <div class="info-box alert">
        <div class="info-box-icon">!</div>
        <div class="info-box-content">
            <strong>Vulnerable Container Images</strong>
            {{container_vulns_data.critical_vuln_count}} container image(s) contain critical vulnerabilities. Update base images and rebuild affected containers.
        </div>
    </div>
    {% endif %}
    {% endif %}
</section>
{% endif %}

<!-- Detailed Findings Appendix -->
{% if host_vulns_data or container_vulns_data or aws_compliance_data or azure_compliance_data or gcp_compliance_data %}
<section id="detailed-findings" class="pagebreak">
    <h2>Appendix: Detailed Findings</h2>
    <p>This section contains granular details for remediation teams.</p>

    {% if host_vulns_data or container_vulns_data %}
    <h3>Detailed CVE Breakdown</h3>

    {% if host_vulns_data and not host_vulns_data.fixable_vulns.empty %}
    <h4>Hosts with Critical, Fixable Vulnerabilities (CVE Risk Score = 10)</h4>
    <div class="info-box tip">
        <div class="info-box-icon">i</div>
        <div class="info-box-content">
            <strong>Quick Win Opportunity</strong>
            These vulnerabilities have fixes available. Patching these systems will significantly reduce your attack surface.
        </div>
    </div>
    <div class="info-box warning">
        <div class="info-box-icon">📊</div>
        <div class="info-box-content">
            <strong>Understanding Risk Score</strong>
            <p style="margin: 0.5rem 0 0 0;">
                This report displays <strong>Critical vulnerabilities with CVSS score 10.0</strong> (the highest severity).
                The <strong>Risk Score</strong> shown represents the vulnerability impact, which is calculated based on:
            </p>
            <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.6;">
                <li><strong>Number of hosts or container images affected</strong> - More affected systems = higher risk</li>
                <li><strong>Number of packages affected</strong> - Widespread package vulnerabilities = higher risk</li>
            </ul>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9em; color: var(--color-text-light);">
                <em>Note: Risk Score differs from CVSS score. CVSS measures vulnerability severity, while Risk Score measures blast radius and organizational impact.</em>
            </p>
        </div>
    </div>
    {{ host_vulns_data.fixable_vulns.to_html() | safe }}

    <div class="action-section" style="margin-top: 2rem;">
        <h3>Host Vulnerability Recommendations</h3>
        <ol class="action-list">
            <li class="priority-critical">
                <span class="action-number">1</span>
                <div class="action-content">
                    <strong>Prioritize <span class="nist-badge nist-identify">IDENTIFY</span><span class="nist-badge nist-respond">RESPOND</span></strong>
                    <p>High CVSS, public exploits, Internet-exposed, and critical hosts first.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">2</span>
                <div class="action-content">
                    <strong>Patch quickly <span class="nist-badge nist-protect">PROTECT</span></strong>
                    <p>OS & software updates; automate where possible; test critical patches.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">3</span>
                <div class="action-content">
                    <strong>Reduce attack surface <span class="nist-badge nist-protect">PROTECT</span></strong>
                    <p>Remove unused software/services, close unnecessary ports, harden configs.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">4</span>
                <div class="action-content">
                    <strong>Secure network & access <span class="nist-badge nist-protect">PROTECT</span></strong>
                    <p>Firewalls, restricted SSH/VPN, segmentation; monitor exposed ports.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">5</span>
                <div class="action-content">
                    <strong>Continuous vulnerability scanning <span class="nist-badge nist-detect">DETECT</span></strong>
                    <p>Regularly scan hosts, confirm remediation, focus on exploitable + Internet-exposed hosts.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">6</span>
                <div class="action-content">
                    <strong>Monitor & detect <span class="nist-badge nist-detect">DETECT</span></strong>
                    <p>Use IDS/EDR; watch logs for suspicious activity.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">7</span>
                <div class="action-content">
                    <strong>Backup & document <span class="nist-badge nist-recover">RECOVER</span></strong>
                    <p>Backup before patching; track remediation; include exposure in reports.</p>
                </div>
            </li>
        </ol>
    </div>
    {% endif %}

    {% if container_vulns_data and not container_vulns_data.fixable_vulns.empty %}
    <h4>Containers with Critical, Fixable Vulnerabilities (CVE Risk Score = 10)</h4>
    <div class="info-box tip">
        <div class="info-box-icon">i</div>
        <div class="info-box-content">
            <strong>Image Update Required</strong>
            Update the base images for these containers and rebuild to remediate the vulnerabilities.
        </div>
    </div>
    <div class="info-box warning">
        <div class="info-box-icon">📊</div>
        <div class="info-box-content">
            <strong>Understanding Risk Score</strong>
            <p style="margin: 0.5rem 0 0 0;">
                This report displays <strong>Critical vulnerabilities with CVSS score 10.0</strong> (the highest severity).
                The <strong>Risk Score</strong> shown represents the vulnerability impact, which is calculated based on:
            </p>
            <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.6;">
                <li><strong>Number of container images affected</strong> - More affected images = higher risk</li>
                <li><strong>Number of packages affected</strong> - Widespread package vulnerabilities = higher risk</li>
            </ul>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9em; color: var(--color-text-light);">
                <em>Note: Risk Score differs from CVSS score. CVSS measures vulnerability severity, while Risk Score measures blast radius and organizational impact.</em>
            </p>
        </div>
    </div>
    {{ container_vulns_data.fixable_vulns.to_html() | safe }}
    {% endif %}
    {% endif %}

    {% if aws_compliance_data or azure_compliance_data or gcp_compliance_data %}
    <h3>Detailed Cloud Compliance Findings</h3>

    {% if aws_compliance_data %}
    <h4>AWS - High/Critical Compliance Findings</h4>
    {{ aws_compliance_data.compliance_detail.to_html() | safe }}

    {% if aws_compliance_data.critical_finding_count > 0 %}
    <h4>AWS - Critical Findings with Remediation Details</h4>
    {{ aws_compliance_data.critical_details.to_html().replace("\\n","<br>") | safe }}
    {% endif %}
    {% endif %}

    {% if azure_compliance_data %}
    <h4>Azure - High/Critical Compliance Findings</h4>
    {{ azure_compliance_data.compliance_detail.to_html(index=False) | safe }}

    {% if azure_compliance_data.critical_finding_count > 0 %}
    <h4>Azure - Critical Findings with Remediation Details</h4>
    {{ azure_compliance_data.critical_details.to_html().replace("\\n","<br>") | safe }}
    {% endif %}

    <div class="action-section" style="margin-top: 2rem;">
        <h3>Cloud Compliance Recommendations</h3>
        <p style="margin-bottom: 1.5rem; color: var(--color-text);">
            Achieving and maintaining cloud compliance requires a systematic approach combining automation, continuous monitoring, and proactive remediation. Follow these best practices to strengthen your compliance posture:
        </p>
        <ol class="action-list">
            <li class="priority-critical">
                <span class="action-number">1</span>
                <div class="action-content">
                    <strong>Implement Continuous Compliance Monitoring <span class="nist-badge nist-detect">DETECT</span></strong>
                    <p>Deploy automated tools like FortiCNAPP to continuously scan cloud environments for configuration drift, policy violations, and compliance gaps. Real-time monitoring enables immediate detection and faster remediation of non-compliant resources before they become security risks.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">2</span>
                <div class="action-content">
                    <strong>Automate Remediation Workflows <span class="nist-badge nist-respond">RESPOND</span></strong>
                    <p>Configure automated responses for common compliance violations such as open security groups, unencrypted storage, or missing tags. Use Infrastructure-as-Code (IaC) to enforce compliant configurations and prevent manual misconfigurations.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">3</span>
                <div class="action-content">
                    <strong>Prioritize Critical & High Severity Findings <span class="nist-badge nist-identify">IDENTIFY</span><span class="nist-badge nist-respond">RESPOND</span></strong>
                    <p>Address critical findings first, focusing on publicly exposed resources, data encryption gaps, IAM misconfigurations, and logging deficiencies. These pose the highest risk to your security posture and regulatory standing.</p>
                </div>
            </li>
            <li class="priority-high">
                <span class="action-number">4</span>
                <div class="action-content">
                    <strong>Establish Policy-as-Code <span class="nist-badge nist-protect">PROTECT</span></strong>
                    <p>Define compliance policies as code to enforce security standards across all cloud accounts and environments. Use tools like Terraform, CloudFormation, or Azure Policy to codify CIS benchmarks, NIST frameworks, and regulatory requirements.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">5</span>
                <div class="action-content">
                    <strong>Enable Comprehensive Audit Logging <span class="nist-badge nist-detect">DETECT</span></strong>
                    <p>Ensure CloudTrail (AWS), Activity Logs (Azure), and Cloud Audit Logs (GCP) are enabled across all regions and accounts. Centralize logs in a SIEM or log analytics platform for compliance reporting and forensic analysis.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">6</span>
                <div class="action-content">
                    <strong>Conduct Regular Compliance Assessments <span class="nist-badge nist-identify">IDENTIFY</span></strong>
                    <p>Schedule recurring compliance scans (weekly or monthly) to track remediation progress and identify new violations. Compare results over time to measure improvement and demonstrate compliance to auditors.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">7</span>
                <div class="action-content">
                    <strong>Implement Least Privilege Access <span class="nist-badge nist-protect">PROTECT</span></strong>
                    <p>Review and restrict IAM permissions to the minimum required for each role. Remove unused accounts, enforce MFA, rotate credentials regularly, and monitor privileged access with session recording and just-in-time access.</p>
                </div>
            </li>
            <li class="priority-medium">
                <span class="action-number">8</span>
                <div class="action-content">
                    <strong>Document & Report Compliance Status <span class="nist-badge nist-identify">IDENTIFY</span></strong>
                    <p>Maintain compliance documentation including policies, procedures, remediation tracking, and audit reports. Generate executive dashboards showing compliance scores, trend analysis, and remediation velocity for stakeholders and auditors.</p>
                </div>
            </li>
        </ol>
        <div class="info-box tip" style="margin-top: 1.5rem;">
            <div class="info-box-icon">💡</div>
            <div class="info-box-content">
                <strong>Continuous Compliance is Key</strong>
                <p style="margin: 0.5rem 0 0 0;">
                    Cloud environments are dynamic—resources are created, modified, and deleted constantly. Point-in-time compliance scans provide only a snapshot.
                    <strong>Continuous compliance monitoring</strong> ensures your security posture remains strong 24/7 by detecting drift immediately and enabling rapid response to new violations.
                </p>
                <p style="margin: 0.5rem 0 0 0;">
                    FortiCNAPP provides real-time compliance monitoring across AWS, Azure, and GCP with automated detection, prioritized remediation guidance, and executive reporting to maintain continuous compliance.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    {% if gcp_compliance_data %}
    <h4>GCP - High/Critical Compliance Findings</h4>
    {{ gcp_compliance_data.compliance_detail.to_html(index=False) | safe }}

    {% if gcp_compliance_data.critical_finding_count > 0 %}
    <h4>GCP - Critical Findings with Remediation Details</h4>
    {{ gcp_compliance_data.critical_details.to_html().replace("\\n","<br>") | safe }}
    {% endif %}
    {% endif %}
    {% endif %}
</section>
{% endif %}

<!-- Recommendations Section -->
<section id="recommendations">
    {% if recommendations %}
    <div class="recommendations">
        {{ recommendations | safe }}
    </div>
    {% else %}
    <div class="recommendations">
        <h2>Recommendations & Next Steps</h2>
        <p>Based on the findings of this assessment, we recommend the following action plan:</p>
        <ol>
            <li><strong>Immediate (0-7 days):</strong> Address all critical vulnerabilities and rotate any exposed secrets identified in this report.</li>
            <li><strong>Short-term (1-4 weeks):</strong> Remediate high-severity compliance findings and investigate behavioral alerts.</li>
            <li><strong>Medium-term (1-3 months):</strong> Implement continuous monitoring with FortiCNAPP and establish remediation workflows.</li>
            <li><strong>Ongoing:</strong> Schedule recurring Cloud Security Assessments to track improvement and detect new risks.</li>
        </ol>
        <p>Engage with your Fortinet account team and partner to review service offerings and prioritize remediation efforts.</p>
    </div>
    {% endif %}
</section>

<!-- FortiCNAPP - One Platform Section -->
<section id="forticnapp-platform" class="pagebreak">
    <h2>Fortinet FortiCNAPP - One Platform</h2>
    <div class="promo-section">
        {% if forticnapp_platform_html %}{{ forticnapp_platform_html | safe }}{% endif %}
    </div>
</section>

<!-- Fortinet Security Fabric Section -->
<section id="fortinet-security-fabric" class="pagebreak">
    <h2>Fortinet Security Fabric</h2>
    <div class="promo-section">
        {% if fortinet_sec_fabric_html %}{{ fortinet_sec_fabric_html | safe }}{% endif %}
    </div>
</section>

<!-- Security Outcomes Section -->
<section id="security-outcomes" class="pagebreak">
    <h2>FortiCNAPP Security Outcomes</h2>
    <div class="promo-section">
        {% if sec_outcomes_html %}{{ sec_outcomes_html | safe }}{% endif %}
    </div>
</section>

<!-- State of Cloud Security Report Section -->
<section id="state-of-cloud" class="pagebreak">
    <h2>State of Cloud Security Report</h2>
    <div class="promo-section">
        {% if state_of_cloud_html %}{{ state_of_cloud_html | safe }}{% endif %}
    </div>
</section>

<footer>
    <p>Generated by FortiCNAPP Cloud Security Assessment Tool</p>
    <p>Report Date: {{date}} | Prepared for: {{customer}} | Author: {{author}}</p>
</footer>

</body>
</html>
